# Анализ падений E2E тестов

## Общая статистика
- **Всего тестов**: 92
- **Прошло**: 21 (22.8%)
- **Упало**: 71 (77.2%)
- **Время выполнения**: 15.2 минуты (с уменьшенными таймаутами)

## Таймауты (уменьшены на 1/3)
- **Test timeout**: 40 секунд (было 60 секунд)
- **Expect timeout**: 20 секунд (было 30 секунд)
- **Action timeout**: 20 секунд (было 30 секунд)
- **Navigation timeout**: 40 секунд (было 60 секунд)

## Основные причины падений тестов

### 1. Превышение таймаута (Test timeout of 40000ms exceeded)
**Количество тестов**: ~68 тестов

**Основная ошибка**: `Target page, context or browser has been closed`

**Причина**: 
- Браузер или страница закрывается до завершения теста
- Приложение не успевает загрузиться или выполнить операции в отведенные 40 секунд
- Уменьшение таймаута на треть привело к тому, что медленные тесты не успевают завершиться

**Затронутые тесты**:
- Все тесты проверки чек-инов (`checkin-persistence`, `checkin-persistence-simple`)
- Все тесты дневного чек-ина (`daily-checkin-flow`, `daily-checkin-flow-simple`)
- Все тесты границ дня (`day-boundary-testing`, `day-boundary-testing-simple`)
- Тесты загрузки контента (`content-loading`)
- Тесты i18n переключения языка (`i18n-language-switching`)
- Тесты реферальной системы (`referral-system`)
- User stories тесты (`epic1-data-persistence`)

**Примеры ошибок**:
```
Error: page.click: Target page, context or browser has been closed
Error: page.waitForTimeout: Target page, context or browser has been closed
Error: expect.toBeVisible: Target page, context or browser has been closed
```

### 2. Элементы не найдены (Element not found)
**Количество тестов**: 2 теста

**Тесты**:
- `points-and-achievements-ui.spec.ts` - тесты обновления профиля ProgressBlock

**Ошибка**: 
```
Locator: locator('[data-name="User frame info block"]')
Expected: visible
Timeout: 10000ms
Error: element(s) not found
```

**Причина**: 
- Элемент `[data-name="User frame info block"]` не отображается на странице
- Возможно, приложение не загружается до нужного состояния
- Страница может быть в другом состоянии, чем ожидает тест

### 3. Неверные значения данных (Data validation failures)
**Количество тестов**: 3 теста

**Тесты**:
- `referral-system.spec.ts` - тесты обработки реферальных кодов

**Ошибки**:
1. `Expected: "987654321", Received: null` - реферальный код не сохраняется
2. `expect(stats).not.toBeNull(), Received: null` - статистика реферера не загружается

**Причина**: 
- Реферальная система не сохраняет данные в localStorage
- Статистика не инициализируется или не загружается
- Возможно, требуется дополнительная настройка или моки для работы реферальной системы

### 4. Проблемы с beforeEach hook
**Количество тестов**: 5 тестов

**Тесты**:
- `i18n-language-switching.spec.ts` - все тесты переключения языка

**Ошибка**: 
```
Test timeout of 40000ms exceeded while running "beforeEach" hook
Error: page.addInitScript: Target page, context or browser has been closed
```

**Причина**: 
- Хук `beforeEach` не успевает выполниться за отведенное время
- Браузер закрывается до инициализации скрипта `__PLAYWRIGHT__`
- Возможно, проблема с настройкой флага E2E перед навигацией

## Успешно прошедшие тесты (21 тест)

Следующие тесты **успешно прошли**:
- `simple-loading.spec.ts` - простые тесты загрузки
- `smart-navigation.spec.ts` - умная навигация
- `direct-link-fullscreen.spec.ts` - прямые ссылки
- `home-progress-display` (частично) - некоторые тесты отображения прогресса

## Рекомендации по исправлению

### 1. Увеличить таймауты обратно или оптимизировать тесты
- Текущие таймауты (40 секунд) недостаточны для многих тестов
- Альтернатива: оптимизировать тесты, убрав лишние ожидания

### 2. Исправить проблему с закрытием браузера
- Проверить, почему браузер закрывается до завершения тестов
- Возможно, проблема в глобальной настройке или teardown

### 3. Исправить селекторы элементов
- Проверить, что `[data-name="User frame info block"]` существует в приложении
- Убедиться, что приложение загружается до нужного состояния

### 4. Исправить реферальную систему
- Проверить логику сохранения реферальных кодов
- Убедиться, что статистика реферера инициализируется

### 5. Оптимизировать beforeEach hooks
- Упростить инициализацию в `i18n-language-switching.spec.ts`
- Проверить, что флаг `__PLAYWRIGHT__` устанавливается корректно

## Выводы

Основная проблема: **уменьшение таймаутов на треть привело к тому, что большинство тестов не успевают завершиться**. Тесты падают из-за превышения таймаута (40 секунд вместо 60), при этом браузер закрывается до завершения операций.

Большинство тестов требуют больше времени для:
- Загрузки приложения
- Выполнения операций с чек-инами
- Обработки навигации
- Загрузки и обработки данных

Рекомендуется либо вернуть таймауты к исходным значениям, либо оптимизировать сами тесты для более быстрого выполнения.

