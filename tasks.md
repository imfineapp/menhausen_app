# РџР»Р°РЅ СЂРµР°Р»РёР·Р°С†РёРё СЂР°СЃС€РёСЂРµРЅРЅРѕР№ СЃРёСЃС‚РµРјС‹ РґРѕСЃС‚РёР¶РµРЅРёР№

## РћР‘Р—РћР  Р—РђР”РђР§Р

**Р¦РµР»СЊ**: Р Р°СЃС€РёСЂРёС‚СЊ СЃРёСЃС‚РµРјСѓ РґРѕСЃС‚РёР¶РµРЅРёР№ СЃ 8 РґРѕ 32, СЂРµР°Р»РёР·РѕРІР°С‚СЊ СЃРёСЃС‚РµРјСѓ РЅР°С‡РёСЃР»РµРЅРёСЏ Рё С…СЂР°РЅРµРЅРёСЏ РґРѕСЃС‚РёР¶РµРЅРёР№.

**РЎР»РѕР¶РЅРѕСЃС‚СЊ**: РЈСЂРѕРІРµРЅСЊ 3-4 (РљРѕРјРїР»РµРєСЃРЅР°СЏ Р·Р°РґР°С‡Р°)

**РљРѕРјРїРѕРЅРµРЅС‚С‹**:
1. Р Р°СЃС€РёСЂРµРЅРёРµ СЃРїРёСЃРєР° РґРѕСЃС‚РёР¶РµРЅРёР№ (РїР°СЂСЃРёРЅРі CSV, РѕР±РЅРѕРІР»РµРЅРёРµ РґР°РЅРЅС‹С…)
2. Р РµР°Р»РёР·Р°С†РёСЏ СЃРёСЃС‚РµРјС‹ РЅР°С‡РёСЃР»РµРЅРёСЏ РґРѕСЃС‚РёР¶РµРЅРёР№ (Р»РѕРіРёРєР° РїСЂРѕРІРµСЂРєРё СѓСЃР»РѕРІРёР№)
3. Р РµР°Р»РёР·Р°С†РёСЏ СЃРёСЃС‚РµРјС‹ С…СЂР°РЅРµРЅРёСЏ РґРѕСЃС‚РёР¶РµРЅРёР№ (Р»РѕРєР°Р»СЊРЅРѕРµ С…СЂР°РЅРµРЅРёРµ/СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ Р±СЌРєРµРЅРґРѕРј)

---

## Р§РђРЎРўР¬ 1: Р РђРЎРЁРР Р•РќРР• РЎРџРРЎРљРђ Р”РћРЎРўРР–Р•РќРР™

### 1.1. РђРЅР°Р»РёР· CSV РґР°РЅРЅС‹С…
- вњ… CSV С„Р°Р№Р» РЅР°Р№РґРµРЅ: imports/Achievements.csv
- вњ… РЎС‚СЂСѓРєС‚СѓСЂР°: 32 РґРѕСЃС‚РёР¶РµРЅРёСЏ СЃ Р°С‚СЂРёР±СѓС‚Р°РјРё (ID, RU/EN РЅР°Р·РІР°РЅРёСЏ, СѓСЃР»РѕРІРёСЏ, XP, РёРєРѕРЅРєР°, С‚РёРї СѓСЃР»РѕРІРёСЏ, РєР°С‚РµРіРѕСЂРёСЏ)

### 1.2. РЎРѕР·РґР°РЅРёРµ СѓС‚РёР»РёС‚С‹ РґР»СЏ РїР°СЂСЃРёРЅРіР° CSV
**Р¤Р°Р№Р»**: utils/achievementsParser.ts

**Р—Р°РґР°С‡Рё**:
- РџР°СЂСЃРёРЅРі CSV С„Р°Р№Р»Р°
- Р’Р°Р»РёРґР°С†РёСЏ РґР°РЅРЅС‹С…
- РџСЂРµРѕР±СЂР°Р·РѕРІР°РЅРёРµ РІ СЃС‚СЂСѓРєС‚СѓСЂСѓ Badge
- РњР°РїРїРёРЅРі РёРєРѕРЅРѕРє РёР· lucide-react РїРѕ РёРјРµРЅРё

**Р—Р°РІРёСЃРёРјРѕСЃС‚Рё**:
- CSV parser Р±РёР±Р»РёРѕС‚РµРєР° (papaparse РёР»Рё РІСЃС‚СЂРѕРµРЅРЅС‹Р№ РїР°СЂСЃРµСЂ)
- lucide-react РґР»СЏ РёРєРѕРЅРѕРє

### 1.3. РћР±РЅРѕРІР»РµРЅРёРµ С‚РёРїРѕРІ РґР°РЅРЅС‹С…
**Р¤Р°Р№Р»**: 	ypes/content.ts

**РР·РјРµРЅРµРЅРёСЏ**:
- Р Р°СЃС€РёСЂРёС‚СЊ BadgesContent.achievements СЃ 8 РґРѕ 32 РґРѕСЃС‚РёР¶РµРЅРёР№
- Р”РѕР±Р°РІРёС‚СЊ РЅРѕРІС‹Рµ РїРѕР»СЏ РІ СЃС‚СЂСѓРєС‚СѓСЂСѓ Badge:
  - xp: number - РѕС‡РєРё РѕРїС‹С‚Р°
  - category: string - РєР°С‚РµРіРѕСЂРёСЏ РґРѕСЃС‚РёР¶РµРЅРёСЏ
  - conditionType: string | string[] - С‚РёРї СѓСЃР»РѕРІРёСЏ (РјРѕР¶РµС‚ Р±С‹С‚СЊ РјР°СЃСЃРёРІ РґР»СЏ РєРѕРјР±РёРЅРёСЂРѕРІР°РЅРЅС‹С…)
  - conditionValue?: number - Р·РЅР°С‡РµРЅРёРµ СѓСЃР»РѕРІРёСЏ (РµСЃР»Рё С‚СЂРµР±СѓРµС‚СЃСЏ)

**РќРѕРІР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° Badge**:
\\\	ypescript
interface Badge {
  id: string;
  title: string; // RU
  titleEn: string; // EN
  description: string; // RU (СѓСЃР»РѕРІРёРµ)
  descriptionEn: string; // EN (СѓСЃР»РѕРІРёРµ)
  icon: React.ReactNode;
  unlocked: boolean;
  unlockedAt?: string | null;
  progress?: number;
  xp: number;
  category: string;
  conditionType: string | string[];
  conditionValue?: number;
}
\\\

### 1.4. РћР±РЅРѕРІР»РµРЅРёРµ С„Р°Р№Р»РѕРІ РєРѕРЅС‚РµРЅС‚Р°
**Р¤Р°Р№Р»С‹**: 
- data/content/ru/badges.json (СЃРѕР·РґР°С‚СЊ)
- data/content/en/badges.json (СЃРѕР·РґР°С‚СЊ)

**Р—Р°РґР°С‡Рё**:
- РЎРѕР·РґР°С‚СЊ JSON С„Р°Р№Р»С‹ СЃ РґР°РЅРЅС‹РјРё РІСЃРµС… 32 РґРѕСЃС‚РёР¶РµРЅРёР№
- РЎС‚СЂСѓРєС‚СѓСЂР° РґРѕР»Р¶РЅР° СЃРѕРѕС‚РІРµС‚СЃС‚РІРѕРІР°С‚СЊ BadgesContent
- Р”РѕР±Р°РІРёС‚СЊ RU Рё EN РІРµСЂСЃРёРё РЅР°Р·РІР°РЅРёР№ Рё РѕРїРёСЃР°РЅРёР№

### 1.5. РћР±РЅРѕРІР»РµРЅРёРµ РєРѕРјРїРѕРЅРµРЅС‚РѕРІ
**Р¤Р°Р№Р»С‹**:
- components/RewardScreen.tsx - РѕР±РЅРѕРІРёС‚СЊ useAchievementData()
- components/BadgesScreen.tsx - РѕР±РЅРѕРІРёС‚СЊ mock РґР°РЅРЅС‹Рµ

**РР·РјРµРЅРµРЅРёСЏ**:
- Р—Р°РјРµРЅРёС‚СЊ hardcoded РґР°РЅРЅС‹Рµ РЅР° РґР°РЅРЅС‹Рµ РёР· ContentContext
- РћР±РЅРѕРІРёС‚СЊ РѕС‚РѕР±СЂР°Р¶РµРЅРёРµ XP РІ BadgeCard
- Р”РѕР±Р°РІРёС‚СЊ С„РёР»СЊС‚СЂР°С†РёСЋ РїРѕ РєР°С‚РµРіРѕСЂРёСЏРј (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ)

---

## Р§РђРЎРўР¬ 2: РЎРРЎРўР•РњРђ РќРђР§РРЎР›Р•РќРРЇ Р”РћРЎРўРР–Р•РќРР™

### 2.1. РЎРѕР·РґР°РЅРёРµ СЃРµСЂРІРёСЃР° РїСЂРѕРІРµСЂРєРё СѓСЃР»РѕРІРёР№
**Р¤Р°Р№Р»**: services/achievementChecker.ts

**Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ**:
- РџСЂРѕРІРµСЂРєР° СѓСЃР»РѕРІРёР№ СЂР°Р·Р±Р»РѕРєРёСЂРѕРІРєРё РґР»СЏ РєР°Р¶РґРѕРіРѕ С‚РёРїР°:
  - 
egistration_checkin - СЂРµРіРёСЃС‚СЂР°С†РёСЏ + 1 С‡РµРє-РёРЅ
  - cards_opened - РѕС‚РєСЂС‹С‚Рѕ N РєР°СЂС‚РѕС‡РµРє
  - 	opic_completed - Р·Р°РІРµСЂС€РµРЅР° С‚РµРјР°
  - rticles_read - РїСЂРѕС‡РёС‚Р°РЅРѕ N СЃС‚Р°С‚РµР№
  - cards_repeated - РїРѕРІС‚РѕСЂРµРЅРѕ N РєР°СЂС‚РѕС‡РµРє
  - streak - Р°РєС‚РёРІРЅРѕСЃС‚СЊ N РґРЅРµР№ РїРѕРґСЂСЏРґ
  - 	opic_repeated - РїРѕРІС‚РѕСЂРµРЅС‹ РІСЃРµ РєР°СЂС‚РѕС‡РєРё С‚РµРјС‹
  - 
eferral_invite - РїСЂРёРіР»Р°С€РµРЅРѕ N РїРѕР»СЊР·РѕРІР°С‚РµР»РµР№
  - 
eferral_premium - РїСЂРёРіР»Р°С€РµРЅРЅС‹Р№ РєСѓРїРёР» premium
  - РљРѕРјР±РёРЅРёСЂРѕРІР°РЅРЅС‹Рµ СѓСЃР»РѕРІРёСЏ (С‡РµСЂРµР· +)

**РРЅС‚РµСЂС„РµР№СЃ**:
\\\	ypescript
interface AchievementChecker {
  checkAchievement(
    achievementId: string, 
    userStats: UserStats
  ): { unlocked: boolean; progress: number };
  
  checkAllAchievements(userStats: UserStats): string[]; // РјР°СЃСЃРёРІ ID СЂР°Р·Р±Р»РѕРєРёСЂРѕРІР°РЅРЅС‹С…
}
\\\

### 2.2. РЎРѕР·РґР°РЅРёРµ СЃРµСЂРІРёСЃР° СЃС‚Р°С‚РёСЃС‚РёРєРё РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ
**Р¤Р°Р№Р»**: services/userStatsService.ts

**Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ**:
- РћС‚СЃР»РµР¶РёРІР°РЅРёРµ СЃС‚Р°С‚РёСЃС‚РёРєРё РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ:
  - РљРѕР»РёС‡РµСЃС‚РІРѕ check-ins
  - РћС‚РєСЂС‹С‚С‹Рµ РєР°СЂС‚РѕС‡РєРё (РїРѕ С‚РµРјР°Рј)
  - Р—Р°РІРµСЂС€РµРЅРЅС‹Рµ С‚РµРјС‹
  - РџСЂРѕС‡РёС‚Р°РЅРЅС‹Рµ СЃС‚Р°С‚СЊРё
  - РџРѕРІС‚РѕСЂРµРЅРЅС‹Рµ РєР°СЂС‚РѕС‡РєРё
  - Streak РґРЅРµР№
  - РџСЂРёРіР»Р°С€РµРЅРЅС‹Рµ РїРѕР»СЊР·РѕРІР°С‚РµР»Рё
  - Premium РїРѕРєСѓРїРєРё С‡РµСЂРµР· СЂРµС„РµСЂР°Р»РѕРІ

**РҐСЂР°РЅРµРЅРёРµ**:
- Р›РѕРєР°Р»СЊРЅРѕ: localStorage РёР»Рё IndexedDB
- РЎРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ Р±СЌРєРµРЅРґРѕРј (РµСЃР»Рё РµСЃС‚СЊ API)

**РРЅС‚РµСЂС„РµР№СЃ**:
\\\	ypescript
interface UserStats {
  checkins: number;
  checkinStreak: number;
  lastCheckinDate: string | null;
  cardsOpened: Record<string, number>; // topicId -> count
  topicsCompleted: string[]; // topicIds
  cardsRepeated: Record<string, number>; // cardId -> count
  topicsRepeated: string[]; // topicIds
  articlesRead: number;
  referralsInvited: number;
  referralsPremium: number;
}
\\\

### 2.3. РРЅС‚РµРіСЂР°С†РёСЏ СЃ СЃРѕР±С‹С‚РёСЏРјРё РїСЂРёР»РѕР¶РµРЅРёСЏ
**РњРµСЃС‚Р° РёРЅС‚РµРіСЂР°С†РёРё**:

1. **Check-in СЃРѕР±С‹С‚РёСЏ**:
   - Р¤Р°Р№Р»: РєРѕРјРїРѕРЅРµРЅС‚ С‡РµРє-РёРЅР°
   - РўСЂРёРіРіРµСЂ: РїРѕСЃР»Рµ СѓСЃРїРµС€РЅРѕРіРѕ check-in
   - Р”РµР№СЃС‚РІРёРµ: РѕР±РЅРѕРІРёС‚СЊ СЃС‚Р°С‚РёСЃС‚РёРєСѓ, РїСЂРѕРІРµСЂРёС‚СЊ РґРѕСЃС‚РёР¶РµРЅРёСЏ

2. **РћС‚РєСЂС‹С‚РёРµ РєР°СЂС‚РѕС‡РєРё**:
   - Р¤Р°Р№Р»: РєРѕРјРїРѕРЅРµРЅС‚ РєР°СЂС‚РѕС‡РєРё
   - РўСЂРёРіРіРµСЂ: РїСЂРё РѕС‚РєСЂС‹С‚РёРё РєР°СЂС‚РѕС‡РєРё
   - Р”РµР№СЃС‚РІРёРµ: СѓРІРµР»РёС‡РёС‚СЊ СЃС‡РµС‚С‡РёРє cardsOpened

3. **Р—Р°РІРµСЂС€РµРЅРёРµ С‚РµРјС‹**:
   - Р¤Р°Р№Р»: РєРѕРјРїРѕРЅРµРЅС‚ С‚РµРјС‹
   - РўСЂРёРіРіРµСЂ: РІСЃРµ РєР°СЂС‚РѕС‡РєРё С‚РµРјС‹ Р·Р°РІРµСЂС€РµРЅС‹
   - Р”РµР№СЃС‚РІРёРµ: РґРѕР±Р°РІРёС‚СЊ topicId РІ topicsCompleted

4. **РџРѕРІС‚РѕСЂ РєР°СЂС‚РѕС‡РєРё**:
   - Р¤Р°Р№Р»: РєРѕРјРїРѕРЅРµРЅС‚ РєР°СЂС‚РѕС‡РєРё
   - РўСЂРёРіРіРµСЂ: РїРѕРІС‚РѕСЂРЅРѕРµ РїСЂРѕС…РѕР¶РґРµРЅРёРµ
   - Р”РµР№СЃС‚РІРёРµ: СѓРІРµР»РёС‡РёС‚СЊ СЃС‡РµС‚С‡РёРє cardsRepeated

5. **Р§С‚РµРЅРёРµ СЃС‚Р°С‚СЊРё**:
   - Р¤Р°Р№Р»: РєРѕРјРїРѕРЅРµРЅС‚ СЃС‚Р°С‚РµР№
   - РўСЂРёРіРіРµСЂ: СЃС‚Р°С‚СЊСЏ РїСЂРѕС‡РёС‚Р°РЅР°
   - Р”РµР№СЃС‚РІРёРµ: СѓРІРµР»РёС‡РёС‚СЊ articlesRead

6. **Р РµС„РµСЂР°Р»СЊРЅР°СЏ СЃРёСЃС‚РµРјР°**:
   - Р¤Р°Р№Р»: РєРѕРјРїРѕРЅРµРЅС‚ СЂРµС„РµСЂР°Р»СЊРЅРѕР№ СЃРёСЃС‚РµРјС‹
   - РўСЂРёРіРіРµСЂ: РїСЂРёРіР»Р°С€РµРЅРёРµ/РїРѕРєСѓРїРєР° premium
   - Р”РµР№СЃС‚РІРёРµ: РѕР±РЅРѕРІРёС‚СЊ referralsInvited/referralsPremium

### 2.4. РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РїСЂРѕРІРµСЂРєР° РґРѕСЃС‚РёР¶РµРЅРёР№
**Р¤Р°Р№Р»**: hooks/useAchievementTracker.ts

**Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ**:
- РҐСѓРє РґР»СЏ РѕС‚СЃР»РµР¶РёРІР°РЅРёСЏ Рё Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРѕР№ РїСЂРѕРІРµСЂРєРё РґРѕСЃС‚РёР¶РµРЅРёР№
- Р—Р°РїСѓСЃРєР°РµС‚ РїСЂРѕРІРµСЂРєСѓ РїРѕСЃР»Рµ РєР°Р¶РґРѕРіРѕ Р·РЅР°С‡РёРјРѕРіРѕ СЃРѕР±С‹С‚РёСЏ
- Р’РѕР·РІСЂР°С‰Р°РµС‚ СЃРїРёСЃРѕРє РЅРѕРІС‹С… РґРѕСЃС‚РёР¶РµРЅРёР№

**РСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ**:
\\\	ypescript
const { checkAndUnlockAchievements, newAchievements } = useAchievementTracker();
\\\

---

## Р§РђРЎРўР¬ 3: РЎРРЎРўР•РњРђ РҐР РђРќР•РќРРЇ Р”РћРЎРўРР–Р•РќРР™

### 3.1. РЎС‚СЂСѓРєС‚СѓСЂР° РґР°РЅРЅС‹С… РґР»СЏ С…СЂР°РЅРµРЅРёСЏ
**РўРёРїС‹**:
\\\	ypescript
interface UserAchievement {
  achievementId: string;
  unlocked: boolean;
  unlockedAt: string | null;
  progress: number; // 0-100
  xp: number;
}

interface UserAchievementsState {
  achievements: Record<string, UserAchievement>;
  totalXP: number;
  unlockedCount: number;
  lastSyncedAt: string | null;
}
\\\

### 3.2. Р›РѕРєР°Р»СЊРЅРѕРµ С…СЂР°РЅРµРЅРёРµ
**Р¤Р°Р№Р»**: services/achievementStorage.ts

**Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ**:
- РЎРѕС…СЂР°РЅРµРЅРёРµ РІ localStorage (РёР»Рё IndexedDB РґР»СЏ Р±РѕР»СЊС€РёС… РѕР±СЉРµРјРѕРІ)
- РЎРµСЂРёР°Р»РёР·Р°С†РёСЏ/РґРµСЃРµСЂРёР°Р»РёР·Р°С†РёСЏ РґР°РЅРЅС‹С…
- Р’РµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ СЃС‚СЂСѓРєС‚СѓСЂС‹ РґР°РЅРЅС‹С…
- РњРёРіСЂР°С†РёСЏ РґР°РЅРЅС‹С… РїСЂРё РѕР±РЅРѕРІР»РµРЅРёСЏС…

**РњРµС‚РѕРґС‹**:
\\\	ypescript
- loadUserAchievements(): UserAchievementsState
- saveUserAchievements(state: UserAchievementsState): void
- updateAchievement(achievementId: string, data: Partial<UserAchievement>): void
- resetAchievements(): void
\\\

### 3.3. РЎРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ Р±СЌРєРµРЅРґРѕРј (РµСЃР»Рё РµСЃС‚СЊ API)
**Р¤Р°Р№Р»**: services/achievementSync.ts

**Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ**:
- Р—Р°РіСЂСѓР·РєР° РґРѕСЃС‚РёР¶РµРЅРёР№ СЃ СЃРµСЂРІРµСЂР°
- РћС‚РїСЂР°РІРєР° РѕР±РЅРѕРІР»РµРЅРёР№ РЅР° СЃРµСЂРІРµСЂ
- Р Р°Р·СЂРµС€РµРЅРёРµ РєРѕРЅС„Р»РёРєС‚РѕРІ (РїРѕСЃР»РµРґРЅРµРµ РёР·РјРµРЅРµРЅРёРµ РїРѕР±РµР¶РґР°РµС‚)
- РћС„Р»Р°Р№РЅ СЂРµР¶РёРј СЃ РїРѕСЃР»РµРґСѓСЋС‰РµР№ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРµР№

**API endpoints (РїСЂРµРґРїРѕР»Р°РіР°РµРјС‹Рµ)**:
\\\	ypescript
GET /api/user/achievements
POST /api/user/achievements/sync
POST /api/user/achievements/unlock
\\\

### 3.4. React Context РґР»СЏ СѓРїСЂР°РІР»РµРЅРёСЏ СЃРѕСЃС‚РѕСЏРЅРёРµРј
**Р¤Р°Р№Р»**: contexts/AchievementsContext.tsx

**Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ**:
- Р¦РµРЅС‚СЂР°Р»РёР·РѕРІР°РЅРЅРѕРµ СѓРїСЂР°РІР»РµРЅРёРµ СЃРѕСЃС‚РѕСЏРЅРёРµРј РґРѕСЃС‚РёР¶РµРЅРёР№
- РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ Р·Р°РіСЂСѓР·РєР° РїСЂРё РёРЅРёС†РёР°Р»РёР·Р°С†РёРё
- РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРµ СЃРѕС…СЂР°РЅРµРЅРёРµ РїСЂРё РёР·РјРµРЅРµРЅРёСЏС…
- РџСЂРµРґРѕСЃС‚Р°РІР»РµРЅРёРµ РјРµС‚РѕРґРѕРІ РґР»СЏ РєРѕРјРїРѕРЅРµРЅС‚РѕРІ

**РҐСѓРєРё**:
\\\	ypescript
const {
  achievements,
  totalXP,
  unlockedCount,
  unlockAchievement,
  updateProgress,
  loadAchievements
} = useAchievements();
\\\

### 3.5. РРЅС‚РµРіСЂР°С†РёСЏ RewardManager
**Р¤Р°Р№Р»**: components/RewardManager.tsx

**РР·РјРµРЅРµРЅРёСЏ**:
- РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РґР°РЅРЅС‹Рµ РёР· AchievementsContext РІРјРµСЃС‚Рѕ mock
- РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїРѕРєР°Р·С‹РІР°С‚СЊ СЌРєСЂР°РЅ РЅР°РіСЂР°РґС‹ РїСЂРё СЂР°Р·Р±Р»РѕРєРёСЂРѕРІРєРµ
- РРЅС‚РµРіСЂРёСЂРѕРІР°С‚СЊ СЃ useAchievementTracker

---

## Р—РђР’РРЎРРњРћРЎРўР Р РРќРўР•Р“Р РђР¦РРћРќРќР«Р• РўРћР§РљР

### Р—Р°РІРёСЃРёРјРѕСЃС‚Рё РјРµР¶РґСѓ РєРѕРјРїРѕРЅРµРЅС‚Р°РјРё:

\\\
AchievementsContext
    в†“
achievementStorage (Р»РѕРєР°Р»СЊРЅРѕРµ С…СЂР°РЅРµРЅРёРµ)
    в†“
achievementSync (СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ API)
    в†“
achievementChecker (РїСЂРѕРІРµСЂРєР° СѓСЃР»РѕРІРёР№)
    в†“
userStatsService (СЃС‚Р°С‚РёСЃС‚РёРєР° РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ)
    в†“
[РљРѕРјРїРѕРЅРµРЅС‚С‹ РїСЂРёР»РѕР¶РµРЅРёСЏ] (СЃРѕР±С‹С‚РёСЏ)
\\\

### РРЅС‚РµРіСЂР°С†РёРѕРЅРЅС‹Рµ С‚РѕС‡РєРё:

1. **ContentContext** в†’ РґР°РЅРЅС‹Рµ Рѕ РґРѕСЃС‚РёР¶РµРЅРёСЏС… (РЅР°Р·РІР°РЅРёСЏ, РѕРїРёСЃР°РЅРёСЏ, РёРєРѕРЅРєРё)
2. **Check-in РєРѕРјРїРѕРЅРµРЅС‚** в†’ userStatsService (РѕР±РЅРѕРІР»РµРЅРёРµ streak)
3. **Card РєРѕРјРїРѕРЅРµРЅС‚** в†’ userStatsService (РѕС‚РєСЂС‹С‚РёРµ/РїРѕРІС‚РѕСЂ РєР°СЂС‚РѕС‡РєРё)
4. **Theme РєРѕРјРїРѕРЅРµРЅС‚** в†’ userStatsService (Р·Р°РІРµСЂС€РµРЅРёРµ С‚РµРјС‹)
5. **Article РєРѕРјРїРѕРЅРµРЅС‚** в†’ userStatsService (С‡С‚РµРЅРёРµ СЃС‚Р°С‚СЊРё)
6. **Referral РєРѕРјРїРѕРЅРµРЅС‚** в†’ userStatsService (РїСЂРёРіР»Р°С€РµРЅРёСЏ)

---

## РџРћРўР•РќР¦РРђР›Р¬РќР«Р• Р’Р«Р—РћР’Р« Р Р Р•РЁР•РќРРЇ

### Р’С‹Р·РѕРІ 1: РџСЂРѕРёР·РІРѕРґРёС‚РµР»СЊРЅРѕСЃС‚СЊ РїСЂРѕРІРµСЂРєРё РІСЃРµС… РґРѕСЃС‚РёР¶РµРЅРёР№
**Р РµС€РµРЅРёРµ**: 
- РљСЌС€РёСЂРѕРІР°РЅРёРµ СЂРµР·СѓР»СЊС‚Р°С‚РѕРІ РїСЂРѕРІРµСЂРєРё
- РџСЂРѕРІРµСЂРєР° С‚РѕР»СЊРєРѕ РґРѕСЃС‚РёР¶РµРЅРёР№, РєРѕС‚РѕСЂС‹Рµ РµС‰Рµ РЅРµ СЂР°Р·Р±Р»РѕРєРёСЂРѕРІР°РЅС‹
- Р”РµР±Р°СѓРЅСЃРёРЅРі С‡Р°СЃС‚С‹С… РїСЂРѕРІРµСЂРѕРє

### Р’С‹Р·РѕРІ 2: РЎРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ РґР°РЅРЅС‹С… РјРµР¶РґСѓ СѓСЃС‚СЂРѕР№СЃС‚РІР°РјРё
**Р РµС€РµРЅРёРµ**:
- API СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ РїСЂРё РЅР°Р»РёС‡РёРё
- Timestamp РґР»СЏ РѕРїСЂРµРґРµР»РµРЅРёСЏ РїРѕСЃР»РµРґРЅРµР№ РІРµСЂСЃРёРё
- РљРѕРЅС„Р»РёРєС‚-СЂРµР·РѕР»СЋС€РЅ СЃС‚СЂР°С‚РµРіРёСЏ

### Р’С‹Р·РѕРІ 3: РћР±СЂР°С‚РЅР°СЏ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ СЃ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёРјРё РґР°РЅРЅС‹РјРё
**Р РµС€РµРЅРёРµ**:
- РњРёРіСЂР°С†РёСЏ РґР°РЅРЅС‹С… РїСЂРё РѕР±РЅРѕРІР»РµРЅРёРё
- Р’РµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ СЃС‚СЂСѓРєС‚СѓСЂС‹
- Fallback РЅР° РґРµС„РѕР»С‚РЅС‹Рµ Р·РЅР°С‡РµРЅРёСЏ

### Р’С‹Р·РѕРІ 4: РЎР»РѕР¶РЅС‹Рµ РєРѕРјР±РёРЅРёСЂРѕРІР°РЅРЅС‹Рµ СѓСЃР»РѕРІРёСЏ
**Р РµС€РµРЅРёРµ**:
- РџР°СЂСЃРёРЅРі СЃС‚СЂРѕРєРё СѓСЃР»РѕРІРёСЏ (split РїРѕ +)
- РџРѕСЃР»РµРґРѕРІР°С‚РµР»СЊРЅР°СЏ РїСЂРѕРІРµСЂРєР° РєР°Р¶РґРѕРіРѕ СѓСЃР»РѕРІРёСЏ
- РљСЌС€РёСЂРѕРІР°РЅРёРµ РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅС‹С… СЂРµР·СѓР»СЊС‚Р°С‚РѕРІ

### Р’С‹Р·РѕРІ 5: РћРїСЂРµРґРµР»РµРЅРёРµ progress РґР»СЏ СЃР»РѕР¶РЅС‹С… СѓСЃР»РѕРІРёР№
**Р РµС€РµРЅРёРµ**:
- Р’С‹С‡РёСЃР»РµРЅРёРµ РїСЂРѕС†РµРЅС‚Р° РІС‹РїРѕР»РЅРµРЅРёСЏ РґР»СЏ РєР°Р¶РґРѕРіРѕ СѓСЃР»РѕРІРёСЏ
- РњРёРЅРёРјР°Р»СЊРЅС‹Р№ РїСЂРѕС†РµРЅС‚ РґР»СЏ РєРѕРјР±РёРЅРёСЂРѕРІР°РЅРЅС‹С… СѓСЃР»РѕРІРёР№
- РћР±РЅРѕРІР»РµРЅРёРµ progress РїСЂРё РєР°Р¶РґРѕРј СЃРѕР±С‹С‚РёРё

---

## РџР›РђРќ Р Р•РђР›РР—РђР¦РР (РџРћРЁРђР“РћР’Рћ)

### Р¤Р°Р·Р° 1: РџРѕРґРіРѕС‚РѕРІРєР° РґР°РЅРЅС‹С… (2-3 С‡Р°СЃР°)
1. РЎРѕР·РґР°С‚СЊ СѓС‚РёР»РёС‚Сѓ РїР°СЂСЃРёРЅРіР° CSV
2. РЎРіРµРЅРµСЂРёСЂРѕРІР°С‚СЊ badges.json РґР»СЏ RU Рё EN
3. РћР±РЅРѕРІРёС‚СЊ С‚РёРїС‹ TypeScript
4. РџСЂРѕС‚РµСЃС‚РёСЂРѕРІР°С‚СЊ Р·Р°РіСЂСѓР·РєСѓ РґР°РЅРЅС‹С…

### Р¤Р°Р·Р° 2: РЎРёСЃС‚РµРјР° С…СЂР°РЅРµРЅРёСЏ (3-4 С‡Р°СЃР°)
1. РЎРѕР·РґР°С‚СЊ achievementStorage service
2. РЎРѕР·РґР°С‚СЊ AchievementsContext
3. РРЅС‚РµРіСЂРёСЂРѕРІР°С‚СЊ СЃ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёРјРё РєРѕРјРїРѕРЅРµРЅС‚Р°РјРё
4. РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ СЃРѕС…СЂР°РЅРµРЅРёСЏ/Р·Р°РіСЂСѓР·РєРё

### Р¤Р°Р·Р° 3: РЎС‚Р°С‚РёСЃС‚РёРєР° РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ (3-4 С‡Р°СЃР°)
1. РЎРѕР·РґР°С‚СЊ userStatsService
2. РћРїСЂРµРґРµР»РёС‚СЊ РјРµСЃС‚Р° РёРЅС‚РµРіСЂР°С†РёРё СЃ СЃРѕР±С‹С‚РёСЏРјРё
3. Р РµР°Р»РёР·РѕРІР°С‚СЊ РѕС‚СЃР»РµР¶РёРІР°РЅРёРµ РєР°Р¶РґРѕРіРѕ С‚РёРїР° СЃРѕР±С‹С‚РёР№
4. РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ РЅР°РєРѕРїР»РµРЅРёСЏ СЃС‚Р°С‚РёСЃС‚РёРєРё

### Р¤Р°Р·Р° 4: РЎРёСЃС‚РµРјР° РїСЂРѕРІРµСЂРєРё СѓСЃР»РѕРІРёР№ (4-5 С‡Р°СЃРѕРІ)
1. РЎРѕР·РґР°С‚СЊ achievementChecker service
2. Р РµР°Р»РёР·РѕРІР°С‚СЊ РїСЂРѕРІРµСЂРєСѓ РєР°Р¶РґРѕРіРѕ С‚РёРїР° СѓСЃР»РѕРІРёСЏ
3. Р РµР°Р»РёР·РѕРІР°С‚СЊ РєРѕРјР±РёРЅРёСЂРѕРІР°РЅРЅС‹Рµ СѓСЃР»РѕРІРёСЏ
4. Р РµР°Р»РёР·РѕРІР°С‚СЊ СЂР°СЃС‡РµС‚ progress
5. РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ РІСЃРµС… С‚РёРїРѕРІ СѓСЃР»РѕРІРёР№

### Р¤Р°Р·Р° 5: РРЅС‚РµРіСЂР°С†РёСЏ Рё Р°РІС‚РѕРјР°С‚РёР·Р°С†РёСЏ (3-4 С‡Р°СЃР°)
1. РЎРѕР·РґР°С‚СЊ useAchievementTracker hook
2. РРЅС‚РµРіСЂРёСЂРѕРІР°С‚СЊ РїСЂРѕРІРµСЂРєСѓ РІ СЃРѕР±С‹С‚РёСЏ РїСЂРёР»РѕР¶РµРЅРёСЏ
3. РћР±РЅРѕРІРёС‚СЊ RewardManager РґР»СЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРіРѕ РїРѕРєР°Р·Р°
4. РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ end-to-end РїРѕС‚РѕРєР°

### Р¤Р°Р·Р° 6: UI РѕР±РЅРѕРІР»РµРЅРёСЏ (2-3 С‡Р°СЃР°)
1. РћР±РЅРѕРІРёС‚СЊ BadgeCard РґР»СЏ РѕС‚РѕР±СЂР°Р¶РµРЅРёСЏ XP Рё РєР°С‚РµРіРѕСЂРёР№
2. РћР±РЅРѕРІРёС‚СЊ BadgesScreen РґР»СЏ СЂР°Р±РѕС‚С‹ СЃ РЅРѕРІС‹РјРё РґР°РЅРЅС‹РјРё
3. Р”РѕР±Р°РІРёС‚СЊ С„РёР»СЊС‚СЂР°С†РёСЋ РїРѕ РєР°С‚РµРіРѕСЂРёСЏРј (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ)
4. РЈР»СѓС‡С€РёС‚СЊ РѕС‚РѕР±СЂР°Р¶РµРЅРёРµ progress

### Р¤Р°Р·Р° 7: РЎРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ API (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ, 3-4 С‡Р°СЃР°)
1. РЎРѕР·РґР°С‚СЊ achievementSync service
2. Р РµР°Р»РёР·РѕРІР°С‚СЊ Р·Р°РіСЂСѓР·РєСѓ СЃ СЃРµСЂРІРµСЂР°
3. Р РµР°Р»РёР·РѕРІР°С‚СЊ РѕС‚РїСЂР°РІРєСѓ РЅР° СЃРµСЂРІРµСЂ
4. Р РµР°Р»РёР·РѕРІР°С‚СЊ РєРѕРЅС„Р»РёРєС‚-СЂРµР·РѕР»СЋС€РЅ
5. РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё

---

## РљРћРњРџРћРќР•РќРўР«, РўР Р•Р‘РЈР®Р©РР• РљР Р•РђРўРР’РќРћР™ Р¤РђР—Р«

1. **Р”РёР·Р°Р№РЅ СЃРёСЃС‚РµРјС‹ СѓСЃР»РѕРІРёР№** - РєР°Рє СЌС„С„РµРєС‚РёРІРЅРѕ С…СЂР°РЅРёС‚СЊ Рё РїСЂРѕРІРµСЂСЏС‚СЊ РєРѕРјР±РёРЅРёСЂРѕРІР°РЅРЅС‹Рµ СѓСЃР»РѕРІРёСЏ
2. **РђР»РіРѕСЂРёС‚Рј СЂР°СЃС‡РµС‚Р° progress** - РєР°Рє С‚РѕС‡РЅРѕ РІС‹С‡РёСЃР»СЏС‚СЊ РїСЂРѕС†РµРЅС‚ РґР»СЏ СЃР»РѕР¶РЅС‹С… СѓСЃР»РѕРІРёР№
3. **РЎС‚СЂР°С‚РµРіРёСЏ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё** - РєР°Рє СЌС„С„РµРєС‚РёРІРЅРѕ СЃРёРЅС…СЂРѕРЅРёР·РёСЂРѕРІР°С‚СЊ РґР°РЅРЅС‹Рµ РјРµР¶РґСѓ СѓСЃС‚СЂРѕР№СЃС‚РІР°РјРё
4. **UX РґР»СЏ РїРѕРєР°Р·Р° РґРѕСЃС‚РёР¶РµРЅРёР№** - СѓР»СѓС‡С€РµРЅРёРµ РѕРїС‹С‚Р° РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ РїСЂРё РїРѕР»СѓС‡РµРЅРёРё РґРѕСЃС‚РёР¶РµРЅРёР№

---

## РњР•РўР РРљР РЈРЎРџР•РҐРђ

- вњ… Р’СЃРµ 32 РґРѕСЃС‚РёР¶РµРЅРёСЏ Р·Р°РіСЂСѓР¶Р°СЋС‚СЃСЏ Рё РѕС‚РѕР±СЂР°Р¶Р°СЋС‚СЃСЏ
- вњ… РЎРёСЃС‚РµРјР° РєРѕСЂСЂРµРєС‚РЅРѕ РїСЂРѕРІРµСЂСЏРµС‚ СѓСЃР»РѕРІРёСЏ Рё СЂР°Р·Р±Р»РѕРєРёСЂСѓРµС‚ РґРѕСЃС‚РёР¶РµРЅРёСЏ
- вњ… РЎС‚Р°С‚РёСЃС‚РёРєР° РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ СЃРѕС…СЂР°РЅСЏРµС‚СЃСЏ Рё РІРѕСЃСЃС‚Р°РЅР°РІР»РёРІР°РµС‚СЃСЏ
- вњ… Progress РєРѕСЂСЂРµРєС‚РЅРѕ РѕС‚РѕР±СЂР°Р¶Р°РµС‚СЃСЏ РґР»СЏ РІСЃРµС… С‚РёРїРѕРІ РґРѕСЃС‚РёР¶РµРЅРёР№
- вњ… РќРѕРІС‹Рµ РґРѕСЃС‚РёР¶РµРЅРёСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїРѕРєР°Р·С‹РІР°СЋС‚СЃСЏ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ
- вњ… Р”Р°РЅРЅС‹Рµ СЃРёРЅС…СЂРѕРЅРёР·РёСЂСѓСЋС‚СЃСЏ (РµСЃР»Рё РµСЃС‚СЊ API)

---

## РЎР›Р•Р”РЈР®Р©РР• РЁРђР“Р

**Р Р•Р–РРњ**: CREATIVE MODE (РґР»СЏ РєРѕРјРїРѕРЅРµРЅС‚РѕРІ С‚СЂРµР±СѓСЋС‰РёС… РґРёР·Р°Р№РЅР°)
РР›Р
**Р Р•Р–РРњ**: IMPLEMENT MODE (РµСЃР»Рё РІСЃРµ РєРѕРјРїРѕРЅРµРЅС‚С‹ СЃРїСЂРѕРµРєС‚РёСЂРѕРІР°РЅС‹)


---

## вњ… РЎРўРђРўРЈРЎ РђР РҐРРўР•РљРўРЈР РќРћР“Рћ Р”РР—РђР™РќРђ

**Р—РђР’Р•Р РЁР•РќРћ**: Р’СЃРµ РєРѕРјРїРѕРЅРµРЅС‚С‹ СЃРїСЂРѕРµРєС‚РёСЂРѕРІР°РЅС‹
рџ“„ **Р”РѕРєСѓРјРµРЅС‚ Р°СЂС…РёС‚РµРєС‚СѓСЂС‹**: memory-bank/creative/achievements-architecture.md

### РЎРїСЂРѕРµРєС‚РёСЂРѕРІР°РЅРЅС‹Рµ РєРѕРјРїРѕРЅРµРЅС‚С‹:
1. вњ… **РЎРёСЃС‚РµРјР° СѓСЃР»РѕРІРёР№** - Р¤СѓРЅРєС†РёРѕРЅР°Р»СЊРЅС‹Р№ РїРѕРґС…РѕРґ СЃ СЂРµРіРёСЃС‚СЂРѕРј РїСЂРѕРІРµСЂС‡РёРєРѕРІ
2. вњ… **РЎРёСЃС‚РµРјР° С…СЂР°РЅРµРЅРёСЏ СЃС‚Р°С‚РёСЃС‚РёРєРё** - Р•РґРёРЅС‹Р№ РѕР±СЉРµРєС‚ UserStats СЃ РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµРј
3. вњ… **РЎРёСЃС‚РµРјР° С…СЂР°РЅРµРЅРёСЏ РґРѕСЃС‚РёР¶РµРЅРёР№** - Record<string, UserAchievement> СЃ Р°РІС‚Рѕ-РїРµСЂРµСЃС‡РµС‚РѕРј
4. вњ… **React Context** - AchievementsContext РґР»СЏ С†РµРЅС‚СЂР°Р»РёР·РѕРІР°РЅРЅРѕРіРѕ СѓРїСЂР°РІР»РµРЅРёСЏ
5. вњ… **РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ РїСЂРѕРІРµСЂРєР°** - useAchievementTracker СЃ debounce

**Р“РѕС‚РѕРІРѕ Рє СЂРµР°Р»РёР·Р°С†РёРё РІ IMPLEMENT MODE**


---

# ПЛАН РЕАЛИЗАЦИИ РЕФЕРАЛЬНОЙ СИСТЕМЫ (LOCALSTORAGE)

## ОБЗОР ЗАДАЧИ

**Цель**: Реализовать систему реферальных ссылок для привлечения новых пользователей через функцию "поделиться" в настройках профиля.

**Сложность**: Уровень 3 (Средняя-сложная задача)

**Компоненты**:
1. Модификация функции "поделиться" для генерации реферальных ссылок
2. Создание утилит для обработки реферальных кодов
3. Интеграция обработки реферальных кодов при инициализации приложения
4. Система хранения реферальных связей в localStorage
5. Интеграция с системой статистики и достижений

**Ограничения**: 
- Хранение данных только в localStorage (локально на устройстве)
- Рефералы учитываются только на том устройстве, где они были приглашены
- Позже потребуется миграция на backend для кросс-устройственной синхронизации

---

## ЧАСТЬ 1: УТИЛИТЫ ДЛЯ РАБОТЫ С РЕФЕРАЛАМИ

### 1.1. Создание referralUtils.ts
**Файл**: `utils/referralUtils.ts`

**Функциональность**:
- Получение реферального кода из Telegram start_param
- Извлечение ID реферера из реферального кода
- Проверка, является ли пользователь новым
- Сохранение информации о реферере
- Обработка реферального кода при первом открытии
- Получение ID реферера текущего пользователя

**Ключевые функции**:
```typescript
getReferralCodeFromStartParam(): string | null
getReferrerIdFromCode(referralCode: string): string | null
isNewUser(): boolean
saveReferrerInfo(referrerId: string): void
processReferralCode(): void
getReferrerId(): string | null
```

**Хранение данных**:
- `menhausen_referral_code` - реферальный код (формат: REF_userId)
- `menhausen_referred_by` - Telegram User ID реферера

**Зависимости**:
- `utils/telegramUserUtils.ts` - для получения User ID и start_param
- `localStorage` - для хранения данных

### 1.2. Обработка edge cases
- Защита от самоприглашения (пользователь не может пригласить сам себя)
- Проверка валидности формата реферального кода
- Защита от повторной регистрации реферера (если уже сохранен)

---

## ЧАСТЬ 2: МОДИФИКАЦИЯ ФУНКЦИИ "ПОДЕЛИТЬСЯ"

### 2.1. Обновление ProfileShareUtils.tsx
**Файл**: `components/ProfileShareUtils.tsx`

**Изменения**:
- Добавить импорт `getTelegramUserId` из `utils/telegramUserUtils`
- Создать функцию `generateReferralLink()` для генерации реферальной ссылки
- Модифицировать `handleShare()` для использования реферальной ссылки
- Формат ссылки: `{appUrl}?startapp=REF_{userId}`

**Формат реферальной ссылки**:
- В Telegram WebApp: `https://t.me/bot/app?startapp=REF_123456789`
- Параметр `startapp` передается через Telegram API как `start_param`

**Fallback**:
- Если нет Telegram User ID, использовать обычную ссылку без реферального кода

### 2.2. Обновление текстов шаринга (опционально)
**Файлы**: 
- `components/LanguageContext.tsx`
- `data/content/ru/ui.json`
- `data/content/en/ui.json`

**Новые ключи** (если нужны):
- `share_text_with_referral` - текст с упоминанием реферальной программы
- `referral_link_copied` - сообщение о копировании реферальной ссылки

---

## ЧАСТЬ 3: ИНТЕГРАЦИЯ В APP.TSX

### 3.1. Обработка при инициализации
**Файл**: `App.tsx`

**Добавить**:
- Импорт `processReferralCode` из `utils/referralUtils`
- Вызов `processReferralCode()` в useEffect при монтировании компонента
- Приоритет: вызывать ДО проверки onboarding, чтобы сохранить реферальный код для новых пользователей

**Место добавления**:
```typescript
// В начале AppContent(), после инициализации Telegram WebApp
useEffect(() => {
  // Обработка реферального кода при первом открытии
  processReferralCode();
}, []);
```

### 3.2. Регистрация реферала после онбординга
**Логика**:
- После завершения онбординга (когда `onboardingCompleted = true`)
- Увеличить счетчик `referralsInvited` у реферера
- Проверить достижения реферера (recruiter, spreader, ambassador)

**Проблема с localStorage**:
- В текущей реализации мы не можем напрямую обновить статистику другого пользователя
- **Временное решение**: сохранять информацию о том, что пользователь пришел по рефералке
- При открытии приложения реферером на его устройстве проверять, есть ли новые рефералы

**Альтернативное решение (для демо)**:
- Создать специальный механизм уведомлений через localStorage events
- Использовать BroadcastChannel API для межвкладковой коммуникации (не работает между устройствами)

### 3.3. Интеграция с системой достижений
**Файл**: `App.tsx` (в функции `handleShowSurvey` или после завершения онбординга)

**Добавить**:
```typescript
import { getReferrerId } from './utils/referralUtils';
import { incrementReferralsInvited } from './services/userStatsService';

// После завершения онбординга
const referrerId = getReferrerId();
if (referrerId) {
  // Отмечаем, что реферал зарегистрирован
  // В localStorage версии: сохраняем флаг для последующей обработки
  localStorage.setItem('menhausen_referral_registered', 'true');
  
  // В будущем: отправка на backend для увеличения счетчика у реферера
}
```

---

## ЧАСТЬ 4: СИСТЕМА УЧЕТА РЕФЕРАЛОВ (LOCALSTORAGE ВЕРСИЯ)

### 4.1. Хранение списка рефералов реферера
**Структура данных**:
```typescript
interface ReferralStorage {
  referrerId: string; // ID пользователя-реферера
  referrals: Array<{
    userId: string; // ID реферала
    registeredAt: string; // ISO дата регистрации
    hasPremium: boolean; // Купил ли премиум
  }>;
}
```

**Ключ localStorage**: `menhausen_referral_list_{referrerId}`

### 4.2. Учет рефералов на устройстве реферера
**Логика**:
1. Когда пользователь делится ссылкой, сохраняем его ID как потенциального реферера
2. При открытии приложения реферером проверяем, есть ли новые регистрации
3. Учитываем только тех, кто зарегистрировался после того, как реферер поделился ссылкой

**Ограничения**:
- Работает только на устройстве реферера
- Не работает, если реферал регистрируется на другом устройстве
- Для полноценной работы нужен backend

### 4.3. Обновление статистики реферера
**Файл**: `utils/referralUtils.ts`

**Добавить функцию**:
```typescript
function updateReferrerStats() {
  const userId = getTelegramUserId();
  if (!userId) return;
  
  // Получаем список рефералов для текущего пользователя
  const referralList = getReferralList(userId);
  
  // Обновляем статистику
  const stats = loadUserStats();
  const updatedStats = {
    ...stats,
    referralsInvited: referralList.referrals.length
  };
  saveUserStats(updatedStats);
}
```

---

## ЧАСТЬ 5: ИНТЕГРАЦИЯ С ДОСТИЖЕНИЯМИ

### 5.1. Автоматическая проверка после регистрации реферала
**Место**: После завершения онбординга новым пользователем

**Логика**:
1. Сохранить информацию о реферале
2. Если пользователь - реферер, обновить его статистику
3. Вызвать проверку достижений для реферера

**Файл**: `App.tsx`

### 5.2. Отображение прогресса реферальных достижений
**Уже реализовано**:
- Достижения `recruiter`, `spreader`, `ambassador` в системе
- Проверка через `achievementChecker.ts`
- Отображение в `BadgesScreen.tsx`

**Требуется**:
- Убедиться, что статистика `referralsInvited` корректно обновляется
- Проверить, что достижения разблокируются при достижении условий

---

## ЧАСТЬ 6: ТЕСТИРОВАНИЕ И ВАЛИДАЦИЯ

### 6.1. Unit тесты
**Файл**: `tests/unit/referralUtils.test.ts`

**Тесты**:
- Получение реферального кода из start_param
- Извлечение ID реферера из кода
- Проверка валидности формата кода
- Защита от самоприглашения
- Сохранение и получение информации о реферере

### 6.2. Интеграционные тесты
**Тесты**:
- Генерация реферальной ссылки в ProfileShareUtils
- Обработка реферального кода при инициализации App
- Интеграция с системой статистики

### 6.3. E2E тесты (опционально)
**Тесты**:
- Сценарий: пользователь делится ссылкой → новый пользователь открывает → регистрация реферала
- Проверка обновления статистики реферера

---

## ЧАСТЬ 7: UI/UX УЛУЧШЕНИЯ (ОПЦИОНАЛЬНО)

### 7.1. Отображение реферальной статистики в профиле
**Файл**: `components/UserProfileScreen.tsx`

**Добавить**:
- Блок с количеством приглашенных пользователей
- Прогресс к следующим реферальным достижениям
- Кнопка "Поделиться" с улучшенным дизайном

### 7.2. Уведомления о новых рефералах
**Место**: При открытии приложения реферером

**Логика**:
- Проверять, появились ли новые рефералы с последнего визита
- Показывать toast-уведомление о новом реферале
- Обновлять счетчик достижений

---

## ДЕТАЛЬНЫЕ ШАГИ РЕАЛИЗАЦИИ

### Шаг 1: Создание утилит
- [x] Создать `utils/referralUtils.ts`
- [x] Реализовать `getReferralCodeFromStartParam()`
- [x] Реализовать `getReferrerIdFromCode()`
- [x] Реализовать `isNewUser()`
- [x] Реализовать `saveReferrerInfo()`
- [x] Реализовать `processReferralCode()`
- [x] Реализовать `getReferrerId()`
- [x] Реализовать `generateReferralLink()`
- [x] Реализовать `updateReferrerStatsFromList()`

### Шаг 2: Модификация функции шаринга
- [x] Обновить `components/ProfileShareUtils.tsx`
- [x] Добавить `generateReferralLink()`
- [x] Интегрировать в `handleShare()`
- [x] Интегрировать в `fallbackShare()`

### Шаг 3: Интеграция в App.tsx
- [x] Добавить импорт `processReferralCode`
- [x] Добавить useEffect для обработки при инициализации
- [x] Добавить логику регистрации реферала после завершения опроса
- [x] Интегрировать с системой статистики

### Шаг 4: Система учета рефералов
- [x] Создать структуру данных для хранения рефералов
- [x] Реализовать функции для работы со списком рефералов
- [x] Обновить статистику реферера

### Шаг 5: Интеграция с достижениями
- [x] Убедиться, что статистика обновляется корректно
- [x] Обновление статистики триггерит событие для проверки достижений
- [x] Достижения `recruiter`, `spreader`, `ambassador` уже поддерживаются в `achievementChecker.ts`

### Шаг 6: Тестирование
- [x] Написать unit тесты для referralUtils (tests/unit/referralUtils.test.ts)
- [x] Написать e2e тесты для реферальной системы (tests/e2e/referral-system.spec.ts)
- [x] Протестировать интеграцию
- [ ] Провести ручное тестирование сценариев

### Шаг 7: Документация
- [ ] Добавить комментарии в код
- [ ] Обновить документацию API (если есть)
- [ ] Задокументировать ограничения localStorage версии

---

## ЗАВИСИМОСТИ И ИНТЕГРАЦИОННЫЕ ТОЧКИ

### Зависимости:
- `utils/telegramUserUtils.ts` - получение User ID и start_param
- `services/userStatsService.ts` - управление статистикой
- `services/achievementChecker.ts` - проверка достижений
- `components/ProfileShareUtils.tsx` - функция шаринга
- `App.tsx` - инициализация приложения

### Интеграционные точки:
- Инициализация приложения (обработка start_param)
- Завершение онбординга (регистрация реферала)
- Функция "поделиться" (генерация реферальной ссылки)
- Система статистики (обновление счетчиков)
- Система достижений (разблокировка реферальных достижений)

---

## ВЫЗОВЫ И РЕШЕНИЯ

### Вызов 1: localStorage ограничения
**Проблема**: Не можем обновить статистику другого пользователя
**Решение**: 
- Временное: учет рефералов только на устройстве реферера
- Долгосрочное: миграция на backend API

### Вызов 2: Определение нового пользователя
**Проблема**: Как понять, что пользователь новый?
**Решение**: Проверка `onboardingCompleted` в `app-flow-progress`

### Вызов 3: Защита от повторной регистрации
**Проблема**: Пользователь может несколько раз проходить онбординг
**Решение**: Проверка наличия сохраненного реферера перед сохранением

### Вызов 4: Формат реферального кода
**Проблема**: Нужен надежный формат для передачи через start_param
**Решение**: Формат `REF_{userId}` с префиксом для валидации

---

## МЕТРИКИ УСПЕХА

- ✅ Реферальные ссылки генерируются корректно с User ID
- ✅ Реферальные коды обрабатываются при первом открытии приложения
- ✅ Информация о реферере сохраняется в localStorage
- ✅ Статистика реферера обновляется (на его устройстве)
- ✅ Реферальные достижения разблокируются при достижении условий
- ✅ Защита от самоприглашения работает
- ✅ Edge cases обработаны корректно

---

## СЛЕДУЮЩИЕ ШАГИ

**РЕЖИМ**: IMPLEMENT MODE

После завершения планирования перейти к реализации:
1. Создание `utils/referralUtils.ts`
2. Модификация `components/ProfileShareUtils.tsx`
3. Интеграция в `App.tsx`
4. Тестирование и валидация

**БУДУЩАЯ МИГРАЦИЯ НА BACKEND**:
- API endpoints для регистрации рефералов
- База данных для хранения связей реферер-реферал
- Синхронизация статистики между устройствами
- Real-time обновление счетчиков рефералов

---

