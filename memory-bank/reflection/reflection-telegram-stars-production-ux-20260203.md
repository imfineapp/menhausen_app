# Reflection: Telegram Stars ‚Äî Production Webhook Fix, UX, Tests

**Date**: 2026-02-03  
**Session Focus**: Production payment fix (pre_checkout_query), premium card UX, post-purchase modal, test coverage  
**Status**: ‚úÖ Completed

---

## üìã Context

- Telegram Stars –æ–ø–ª–∞—Ç–∞ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (create-premium-invoice, handle-payment-webhook, Ed25519 –ø–æ–¥–ø–∏—Å—å).
- –ù–∞ **–ø—Ä–æ–¥–∞–∫—à–µ–Ω-–±–æ—Ç–µ** –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª –ø–ª–∞—Ç—ë–∂ –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π –≤ –ª–æ–≥–∞—Ö webhook:  
  `query is too old and response timeout expired or query ID is invalid`.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–∞–≤–∫–∏ UX (–∑–Ω–∞—á–æ–∫ –ø—Ä–µ–º–∏—É–º —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫, —É–±—Ä–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏) –∏ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏.

---

## üîß –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ pre_checkout_query (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)

**–ü—Ä–æ–±–ª–µ–º–∞**  
–û—Ç–≤–µ—Ç –Ω–∞ `pre_checkout_query` –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è **–ø–µ—Ä–≤—ã–º** —Ç–æ–∫–µ–Ω–æ–º –∏–∑ —Å–ø–∏—Å–∫–∞ (`botTokens[0]`). –ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è **–ø—Ä–æ–¥–∞–∫—à–µ–Ω-–±–æ—Ç–æ–º** (botId –∏–∑ payload). –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–º –≤ env –±—ã–ª –¥—Ä—É–≥–æ–π –±–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, staging), –æ—Ç–≤–µ—Ç —à—ë–ª –æ—Ç –¥—Ä—É–≥–æ–≥–æ –±–æ—Ç–∞ ‚Üí Telegram –≤–æ–∑–≤—Ä–∞—â–∞–ª "query ID is invalid" –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç.

**–†–µ—à–µ–Ω–∏–µ**  
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è **`getBotTokenByBotId(payloadBotId)`**: –ø–æ `payload.b` (botId –∏–∑ invoice_payload) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω—É–∂–Ω—ã–π —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ `getBotInfo(token)` –ø–æ –≤—Å–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–∞–º.
- –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `pre_checkout_query` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–∫–µ–Ω —Ç–æ–≥–æ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–ª –∏–Ω–≤–æ–π—Å** (–∏–∑ payload), –∞ –Ω–µ `botTokens[0]`.
- –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ (–ª–∏–º–∏—Ç Telegram 10 —Å–µ–∫):
  - Supabase-–∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–ª—è `pre_checkout_query` (–Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–∞).
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∞ —Å–¥–µ–ª–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π (`checkPlanAvailabilitySync`).
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ `pre_checkout_query` –∏–¥—ë—Ç –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è `successful_payment`.
- –í `catch` –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –æ—Ç–≤–µ—Ç –≤ Telegram –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º** —Ç–æ–∫–µ–Ω–æ–º (–ø–æ payload –∏–ª–∏ fallback).

**–§–∞–π–ª—ã**  
- `supabase/functions/handle-payment-webhook/index.ts`: –∏–º–ø–æ—Ä—Ç `getBotInfo`, `getBotTokenByBotId`, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∞, –≤—ã–±–æ—Ä —Ç–æ–∫–µ–Ω–∞ –ø–æ `payload.b`/`payload.botId`.

**–ò—Ç–æ–≥**  
–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è `handle-payment-webhook` –æ–ø–ª–∞—Ç–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–±–æ—Ç–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å; –æ—Ç–≤–µ—Ç –Ω–∞ pre_checkout_query –∏–¥—ë—Ç —Å —Ç–æ–≥–æ –∂–µ –±–æ—Ç–∞, —á—Ç–æ —Å–æ–∑–¥–∞–ª –∏–Ω–≤–æ–π—Å.

---

### 2. UX: –∑–Ω–∞—á–æ–∫ ¬´–ü—Ä–µ–º–∏—É–º¬ª —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫

**–ó–∞–ø—Ä–æ—Å**  
–ö–æ–≥–¥–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º, –≤ —Å–ø–∏—Å–∫–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –∑–Ω–∞—á–æ–∫ ¬´–ü—Ä–µ–º–∏—É–º¬ª ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≥—Ä–µ—Å—Å, –∫–∞–∫ —É –æ–±—ã—á–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.

**–†–µ—à–µ–Ω–∏–µ**  
–í `ThemeCard.tsx`:
- –ü–æ–∫–∞–∑ –±–ª–æ–∫–∞ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞—á–∫–æ–º: —É—Å–ª–æ–≤–∏–µ –∑–∞–º–µ–Ω–µ–Ω–æ —Å `(matchText || isPremium)` –Ω–∞ `(matchText || isThemeLocked)`.
- –ü–æ–∫–∞–∑ –∑–Ω–∞—á–∫–∞ ¬´–ü—Ä–µ–º–∏—É–º¬ª: —Å `isPremium` –Ω–∞ `isThemeLocked` (—Ç.–µ. –ø—Ä–µ–º–∏—É–º-—Ç–µ–º–∞ –∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–µ–º–∏—É–º–∞).

**–§–∞–π–ª—ã**  
- `components/ThemeCard.tsx`

**–ò—Ç–æ–≥**  
–£ –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–µ–º–∏—É–º-–∫–∞—Ä—Ç–æ—á–∫–∏ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ (–ø—Ä–æ—Ü–µ–Ω—Ç + –ø—Ä–æ–≥—Ä–µ—Å—Å), –±–µ–∑ –∑–Ω–∞—á–∫–∞ ¬´–ü—Ä–µ–º–∏—É–º¬ª.

---

### 3. –£–±—Ä–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞**  
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –º–æ–¥–∞–ª–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º ¬´–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ Premium! –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö¬ª.

**–†–µ—à–µ–Ω–∏–µ**  
- –í `PaymentsScreen.tsx` —É–±—Ä–∞–Ω –≤—ã–∑–æ–≤ `showAlert`/`alert` –ø–æ—Å–ª–µ `paymentStatus === 'paid'`; –ø—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ webhook –∏ —Å–æ–±—ã—Ç–∏–µ `premium:activated`, UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –º–æ–¥–∞–ª–∫–∏.
- –í `data/content/ru/payments.json` –∏ `data/content/en/payments.json` —Ç–µ–∫—Å—Ç `successWithPlan` –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ ¬´Premium —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!¬ª / ¬´Premium successfully activated!¬ª (–Ω–∞ —Å–ª—É—á–∞–π –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è).

**–§–∞–π–ª—ã**  
- `components/PaymentsScreen.tsx`, `data/content/ru/payments.json`, `data/content/en/payments.json`

---

### 4. –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ**  
- **`tests/unit/premiumSignature.test.ts`**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Ed25519, –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∏–∑ localStorage, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ (–≤–∞–ª–∏–¥–Ω–∞—è/–Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è), –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞.
- **`tests/unit/telegramStarsPaymentService.test.ts`**: —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ (—É—Å–ø–µ—Ö –∏ –æ—à–∏–±–∫–∏), –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω–≤–æ–π—Å–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ paid/cancelled/failed, –ø–æ–ª–Ω—ã–π flow –ø–æ–∫—É–ø–∫–∏, –º–æ–∫–∏ Telegram –∏ fetch.
- **`tests/unit/PaymentsScreen.test.tsx`**: —Ä–µ–Ω–¥–µ—Ä —ç–∫—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç—ã —Å LanguageProvider + ContentProvider, –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö testid, —Ç.–∫. –º–æ–∫–∏ –º–µ–Ω—è—é—Ç –¥–µ—Ä–µ–≤–æ).

**–ò—Ç–æ–≥**  
–í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç; –ª–∏–Ω—Ç–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –±–µ–∑ –æ—à–∏–±–æ–∫.

---

## üéØ –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ —Ö–æ—Ä–æ—à–æ

- **–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–æ—à–∏–±–∫–∏** –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ª–æ–≥–∞–º: –æ—Ç–≤–µ—Ç –Ω–µ –æ—Ç —Ç–æ–≥–æ –±–æ—Ç–∞ ‚Üí —è–≤–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ ¬´—Ç–æ—Ç –∂–µ –±–æ—Ç¬ª –∏ –≤—ã–±–æ—Ä —Ç–æ–∫–µ–Ω–∞ –ø–æ `payload.b`.
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ pre_checkout_query**: –æ—Ç–∫–∞–∑ –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è Supabase –∏ –æ—Ç async –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞–Ω–∞ —É–º–µ–Ω—å—à–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞ 10 —Å–µ–∫.
- **–û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –±–æ—Ç–∞**: botId –≤ payload —É–∂–µ –µ—Å—Ç—å –∏–∑ create-premium-invoice; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –µ–≥–æ –≤ webhook —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É.
- **UX –∏ —Ç–µ—Å—Ç—ã** —Å–¥–µ–ª–∞–Ω—ã –≤ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö.

---

## üìå –£—Ä–æ–∫–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **Multi-bot webhook**  
   –û–¥–∏–Ω URL webhook –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ—Ç–æ–≤ –¥–æ–ø—É—Å—Ç–∏–º, –Ω–æ –æ—Ç–≤–µ—Ç –Ω–∞ `pre_checkout_query` –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å **—Ç–µ–º –∂–µ —Ç–æ–∫–µ–Ω–æ–º**, –∫–æ—Ç–æ—Ä—ã–º —Å–æ–∑–¥–∞–Ω –∏–Ω–≤–æ–π—Å/–ø–æ–ª—É—á–µ–Ω update. –ò–Ω–∞—á–µ Telegram –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "query ID is invalid" –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç.

2. **–õ–∏–º–∏—Ç 10 —Å–µ–∫—É–Ω–¥**  
   –î–ª—è `pre_checkout_query` –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë –¥–æ –æ—Ç–≤–µ—Ç–∞: –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ë–î-–∫–ª–∏–µ–Ω—Ç, –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏—Ö —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ¬´—Ç—è–∂—ë–ª–æ–π¬ª –ª–æ–≥–∏–∫–∏ ‚Äî –∫—ç—à –∏–ª–∏ –±—ã—Å—Ç—Ä—ã–π lookup –ø–æ payload (–Ω–∞–ø—Ä–∏–º–µ—Ä, botId ‚Üí token).

3. **–ó–Ω–∞—á–æ–∫ –ø—Ä–µ–º–∏—É–º**  
   –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –µ–≥–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ç–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (`isThemeLocked`), –∞ –Ω–µ –ø–æ —Ñ–∞–∫—Ç—É ¬´—Ç–µ–º–∞ –ø—Ä–µ–º–∏—É–º¬ª (`isPremium`), —á—Ç–æ–±—ã —É –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª —Å—Ç–∞—Ç—É—Å.

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

- –ü–ª–∞–Ω: `memory-bank/tasks.md` (Telegram Stars Integration), `memory-bank/telegram-stars-payment-plan-detailed.md`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/test-payment-flow.md`, `docs/premium-status-encryption-options.md`
- –†–µ—Ñ–ª–µ–∫—Å–∏—è –ø–æ multi-bot: `memory-bank/reflection/reflection-multi-bot-support-and-security-updates-20260130.md`

---

**–ê–≤—Ç–æ—Ä —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏**: Session (REFLECT)  
**–î–∞—Ç–∞**: 2026-02-03
