# Memory Bank: Tasks

## Current Task
‚úÖ **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∫–∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (streak –∏ referral)** (branch: `user-achievements-system`)

Mode: **COMPLETED**  
Status: **‚úÖ COMPLETED - READY FOR ARCHIVE**

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 2025-11-11

### –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (reward screen) –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ —Å—Ç–∞—Ç—å—è–º–∏ - –ø–æ–∫–∞–∑ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–Ω–∞–∑–∞–¥" –∏–∑ —Å—Ç–∞—Ç—å–∏
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ streak - –ø–æ–∫–∞–∑ –Ω–∞ home –ø–æ—Å–ª–µ —á–µ–∫–∏–Ω–∞
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å referral - –ø–æ–∫–∞–∑ –Ω–∞ profile

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `types/achievements.ts` - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ `shownOnHomeAfterCheckin`, `shownOnProfile`
- `contexts/AchievementsContext.tsx` - –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–ª–∞–≥–æ–≤
- `services/achievementStorage.ts` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–ª–∞–≥–æ–≤
- `App.tsx` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ª–æ–≥–∏–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞, useEffect –¥–ª—è home –∏ profile
- `components/ArticleScreen.tsx` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚úÖ –õ–∏–Ω—Ç–µ—Ä—ã: –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤: –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
- ‚úÖ –Æ–Ω–∏—Ç —Ç–µ—Å—Ç—ã: 312 passed | 1 skipped

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `memory-bank/achievements-notification-mechanics.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∫–∏

---

## Previous Task (Completed)
**Task**: **Fix Memory Leak Risk from Uncleaned Timeouts + Update E2E Tests for Branch Changes** (branch: `user-achievements-system`)                                                                                                                                                      

Mode: **ARCHIVE COMPLETE**  
Status: **TASK CLOSED ‚úÖ READY FOR VAN MODE**

## Status
- [x] Initialization complete
- [x] Planning complete
- [x] Implementation complete
- [x] Reflection complete
- [x] Archiving

## Archive
- **Date**: 2025-11-07
- **Archive Document**: `memory-bank/archive/archive-fix-memory-leak-and-e2e-tests-20251107.md`
- **Status**: ‚úÖ COMPLETED
- **Verification**:
  - `npx playwright test`
  - `npm run lint:all`

## Reflection Highlights
- **What Went Well**: Shared Playwright helpers (`seedCheckinHistory`, `primeAppForHome`) let every suite skip brittle onboarding flows; reward handling now lives in one place; smart-navigation logic has a fast deterministic test.                        
- **Challenges**: Legacy flows hid multiple failure modes (reward screen, referral stats, day-boundary resets); ensuring selectors stayed language-neutral required new regex guards.                                                                         
- **Lessons Learned**: Prefer state priming over replaying long UI scripts; isolate business logic in lightweight checks when full E2E adds little value; keep helper APIs tight so updates cascade automatically.                                            
- **Next Steps**: Use VAN MODE to start the next task.

### Part 1: Memory Leak Fix (COMPLETED)
Fix memory leak risks and race conditions from setTimeout calls in App.tsx that lack proper cleanup guards. Prevent calls to functions on unmounted components and ensure all timeouts are properly cleaned up, including nested timeouts.

### Part 2: E2E Tests Update (COMPLETED)
Analyze all changes introduced in the `user-achievements-system` branch and update each failing e2e test to properly reflect the new application behavior, including:
- Achievement system integration
- Referral system functionality  
- Articles feature
- Timeout cleanup changes
- Any other behavioral changes

### Scope

**Part 1: Memory Leak Fix (COMPLETED)**
- ‚úÖ Fix timeout cleanup in `handleCheckInSubmit` (line ~892)
- ‚úÖ Fix timeout cleanup in `handleCardExerciseComplete` (line ~1282)
- ‚úÖ Fix timeout cleanup in `handleThemeCardClick` (line ~1348)
- ‚úÖ Fix nested timeout cleanup in Telegram WebApp initialization (lines ~293, ~302)
- ‚úÖ Add mounted guards to timeout callbacks to prevent state updates on unmounted components
- ‚úÖ Ensure Promise-based setTimeout (line ~540) is handled appropriately

**Part 2: E2E Tests Update (COMPLETED)**
- Analyze all changes in `user-achievements-system` branch vs `main`
- Identify which changes affect each failing e2e test
- Update 71 failing e2e tests to reflect new application behavior
- Ensure tests account for:
  - Achievement system (checking/unlocking achievements after actions)
  - Referral system (referral code processing, stats updates)
  - Articles feature (new screens, navigation)
  - Timeout behavior changes (mounted guards, cleanup)
  - Any navigation flow changes
  - Any UI/UX changes affecting selectors or interactions

### Problem Analysis

**Current State:**
- Timeout refs are defined: `checkInTimeoutRef`, `cardExerciseTimeoutRef`, `themeCardClickTimeoutRef`, `telegramTimeoutRefs`
- Cleanup useEffect exists (lines 598-625) that clears timeouts on unmount
- However, timeout callbacks can still execute after component unmounts, causing:
  - Calls to `setEarnedAchievementIds` on unmounted component
  - Calls to `navigateTo` on unmounted component
  - Calls to `checkAndShowAchievements` on unmounted component
  - Race conditions when multiple timeouts fire simultaneously

**Specific Issues:**
1. **handleCheckInSubmit** (line ~892): Timeout callback calls `setEarnedAchievementIds` and `navigateTo` without mounted check
2. **handleCardExerciseComplete** (line ~1282): Timeout callback calls `checkAndShowAchievements` without mounted check
3. **handleThemeCardClick** (line ~1348): Timeout callback calls `checkAndShowAchievements` without mounted check
4. **Telegram WebApp nested timeout** (line ~302): Nested setTimeout for fullscreen might not be cleaned if parent is cleared
5. **Promise-based setTimeout** (line ~540): No cleanup mechanism for Promise delay

### Checklist

**Part 1: Memory Leak Fix (COMPLETED)**
- [x] Add `isMountedRef` to track component mount state
- [x] Update `handleCheckInSubmit` timeout callback with mounted guard
- [x] Update `handleCardExerciseComplete` timeout callback with mounted guard
- [x] Update `handleThemeCardClick` timeout callback with mounted guard
- [x] Fix nested Telegram WebApp timeout cleanup (already handled by existing cleanup useEffect)
- [x] Review Promise-based setTimeout usage (line ~540) for cleanup needs (added mounted guards in checkAndShowAchievements)
- [x] Ensure all timeout callbacks check mounted state before state updates
- [x] Run lint and type check (`npm run lint:all`)

**Part 2: E2E Tests Update (COMPLETED)**
- [x] Analyze branch changes: list all modified files and their impact
- [x] Create skipRewardScreen utility function to handle reward screen navigation
- [x] Update skipSurvey to handle reward screen after first check-in
- [x] Update completeCheckin to handle reward screen after achievement unlock
- [x] Update navigateToHome to handle reward screen
- [x] Update basic-functionality.spec.ts tests to handle reward screen and check-in screen
- [x] Update checkin-persistence-simple.spec.ts to use completeCheckin helper
- [x] Update content-loading.spec.ts to handle check-in screen and reward screen
- [x] Update home-progress-display-simple.spec.ts to use completeCheckin helper
- [x] Improve completeCheckin to check if on check-in screen before clicking
- [x] Improve completeSurvey to properly wait for buttons to be enabled
- [x] Reduce all timeouts from 10+ seconds to 5 seconds for faster test execution
- [x] Update checkin-persistence.spec.ts to use completeCheckin helper
- [x] Update daily-checkin-flow.spec.ts to use completeCheckin helper
- [x] Update home-progress-display.spec.ts to use completeCheckin helper
- [x] Update day-boundary-testing-simple.spec.ts to use completeCheckin helper
- [x] Update day-boundary-testing.spec.ts to use completeCheckin helper
- [x] Update i18n-language-switching.spec.ts to new navigation helpers
- [x] Update points-and-achievements-ui.spec.ts to use navigation helpers
- [x] Update referral-system.spec.ts to use navigation helpers
- [x] Rewrite smart-navigation.spec.ts to use shared survey loader
- [x] Rewrite direct-link-fullscreen.spec.ts to use shared helpers
- [x] Update simple-loading.spec.ts to use navigation helpers
- [x] Update basic-functionality.spec.ts to use seeded home state
- [x] Update home-progress-display specs to seed progress data
- [x] Categorize remaining failing tests by type of change needed (all suites now pass after helper refactor)
- [x] For each remaining failing test:
  - [x] Identify root cause (change-related vs infrastructure)
  - [x] Update test to account for new behavior
  - [x] Verify test passes after update
- [x] Run full e2e test suite and verify all tests pass (`npx playwright test`)
- [x] Document any tests that need infrastructure fixes (none remaining)

### Acceptance Criteria

**Part 1: Memory Leak Fix (COMPLETED)**
- ‚úÖ All setTimeout callbacks check component mount state before executing
- ‚úÖ All timeouts are properly cleaned up on component unmount
- ‚úÖ Nested timeouts are properly handled and cleaned
- ‚úÖ No state updates occur on unmounted components
- ‚úÖ No race conditions from redundant achievement checks
- ‚úÖ No memory leaks from uncleaned timeouts
- ‚úÖ CI passes; no new eslint/type errors

**Part 2: E2E Tests Update (COMPLETED)**
- All 71 failing e2e tests are analyzed and categorized
- All change-related test failures are fixed
- All tests pass after updates
- Tests properly account for:
  - Achievement system behavior (reward screen navigation, achievement checks)
  - Referral system behavior (referral processing, stats updates)
  - Articles feature (new screens, navigation)
  - Timeout behavior changes (async operations, mounted guards)
  - Navigation flow changes
  - UI/selector changes
- Infrastructure-related failures are documented separately
- Test updates are documented with rationale
- Full e2e test suite passes: `npm run test:e2e`

### Implementation Plan (Level 3)

#### Part 1: Memory Leak Fix (COMPLETED)
See implementation summary below.

#### Part 2: E2E Tests Update (COMPLETED)

**Step 1: Analyze Branch Changes**

1. **Get comprehensive change list:**
   ```bash
   git diff origin/main...HEAD --name-status
   git log origin/main..HEAD --oneline
   ```

2. **Categorize changes:**
   - **Achievement System:**
     - New files: `contexts/AchievementsContext.tsx`, `services/achievementChecker.ts`, `services/achievementStorage.ts`, `services/userStatsService.ts`
     - Modified: `App.tsx` (achievement checking, reward screen navigation)
     - Impact: Tests may need to handle achievement checks after actions, reward screen navigation
   
   - **Referral System:**
     - New files: `utils/referralUtils.ts`
     - Modified: `App.tsx` (referral code processing on init)
     - Impact: Tests may need to account for referral processing, stats updates
   
   - **Articles Feature:**
     - New files: `components/AllArticlesScreen.tsx`, `components/ArticleScreen.tsx`
     - Modified: `App.tsx` (new screens: 'all-articles', 'article')
     - Impact: Tests may need to handle new navigation paths
   
   - **Timeout Cleanup:**
     - Modified: `App.tsx` (mounted guards, cleanup)
     - Impact: Tests may need longer waits or different expectations for async operations
   
   - **Other Changes:**
     - Modified: Various components, content files, test utilities
     - Impact: Selectors, navigation flows, content structure

**Step 2: Map Failing Tests to Changes**

For each of the 71 failing tests, determine:
1. **Test file and test name**
2. **Failure type:**
   - Change-related (needs update)
   - Infrastructure (timeout/page closure - may be pre-existing)
3. **Root cause:**
   - Achievement system integration
   - Referral system processing
   - Navigation flow changes
   - Selector changes
   - Timeout/async behavior changes
   - Infrastructure issues

**Step 3: Update Tests by Category**

1. **Achievement System Tests:**
   - Add handling for achievement checks after actions
   - Add handling for reward screen navigation
   - Update expectations for achievement-related state changes
   - Example: After check-in, may navigate to reward screen instead of home

2. **Referral System Tests:**
   - Account for referral code processing on app init
   - Handle referral stats updates
   - Update expectations for referral-related behavior

3. **Navigation Flow Tests:**
   - Update navigation expectations
   - Handle new screens (articles)
   - Account for new navigation paths

4. **Timeout/Async Behavior Tests:**
   - Adjust wait times if needed
   - Update expectations for async operations
   - Handle mounted guard behavior

5. **Infrastructure Issues:**
   - Document tests that fail due to infrastructure
   - Create separate issue/task for infrastructure fixes

**Step 4: Test Update Process**

For each test file:
1. Read the test file
2. Identify which changes affect it
3. Update test to reflect new behavior:
   - Update selectors if UI changed
   - Update navigation expectations
   - Add handling for new features (achievements, referrals)
   - Adjust timeouts/waits if needed
4. Run the specific test to verify it passes
5. Document changes made

**Step 5: Verification**

1. Run full e2e test suite: `npm run test:e2e`
2. Verify all tests pass
3. Document any remaining infrastructure issues
4. Update test documentation if needed

### Original Implementation Plan (Level 2 - COMPLETED)

#### Overview (COMPLETED)
Add mounted state tracking and guards to all timeout callbacks to prevent memory leaks and race conditions. Ensure proper cleanup of all timeouts, including nested ones.

#### Files Modified (COMPLETED)
- `App.tsx` (primary file with all timeout issues)

#### Implementation Steps (COMPLETED)

1. ‚úÖ **Add Mounted State Tracking**
   - Added `isMountedRef` using `useRef<boolean>(true)`
   - Set to `true` in useEffect on mount
   - Set to `false` in cleanup function on unmount

2. ‚úÖ **Fix handleCheckInSubmit Timeout (line ~892)**
   - Added mounted check before `setEarnedAchievementIds` and `navigateTo`
   - Verified timeout is cleared before setting new one
   - Added mounted guard in timeout callback

3. ‚úÖ **Fix handleCardExerciseComplete Timeout (line ~1282)**
   - Added mounted check before `checkAndShowAchievements`
   - Verified timeout is cleared before setting new one
   - Added mounted guard in timeout callback

4. ‚úÖ **Fix handleThemeCardClick Timeout (line ~1348)**
   - Added mounted check before `checkAndShowAchievements`
   - Verified timeout is cleared before setting new one
   - Added mounted guard in timeout callback

5. ‚úÖ **Fix Nested Telegram WebApp Timeout (lines ~293, ~302)**
   - Verified nested `fullscreen` timeout is stored in ref
   - Verified cleanup for nested timeout in the cleanup useEffect

6. ‚úÖ **Review Promise-based setTimeout (line ~540)**
   - Added mounted guards in `checkAndShowAchievements` function
   - Prevents state updates after unmount

7. ‚úÖ **Update Cleanup useEffect (lines 598-625)**
   - Verified all timeout refs are cleared
   - Added separate useEffect to set `isMountedRef.current = false` on unmount
   - Verified nested timeout cleanup is comprehensive

#### Potential Challenges

**Part 1: Memory Leak Fix (RESOLVED)**
- ‚úÖ **Nested timeout cleanup**: Handled through refs and cleanup useEffect
- ‚úÖ **Promise cancellation**: Handled through mounted guards
- ‚úÖ **Race conditions**: Handled through mounted guards and timeout clearing
- ‚úÖ **Testing**: Unit tests pass, implementation verified

**Part 2: E2E Tests Update (NEW)**
- **Test categorization**: Need to distinguish change-related failures from infrastructure issues
- **Achievement system**: Tests may need to handle reward screen navigation after actions
- **Referral system**: Tests may need to account for async referral processing
- **Navigation changes**: Tests may need updated selectors and expectations
- **Timeout behavior**: Tests may need adjusted wait times for async operations
- **Test isolation**: Ensure test updates don't break other tests
- **Infrastructure issues**: Some failures may be pre-existing and need separate fixes

#### Testing Strategy

**Part 1: Memory Leak Fix (COMPLETED)**
- ‚úÖ Unit tests: All 312 tests pass
- ‚úÖ Lint check: All checks pass
- Manual testing: Navigate quickly between screens to trigger unmounts during timeout execution (recommended)
- Verify no console errors from state updates on unmounted components (recommended)

**Part 2: E2E Tests Update (NEW)**
- **Incremental approach**: Update tests one file at a time
- **Run specific tests**: Use Playwright's test filtering to run individual tests
- **Verify after each update**: Run updated test to ensure it passes
- **Full suite verification**: Run `npm run test:e2e` after all updates
- **Documentation**: Document changes made to each test and why
- **Infrastructure issues**: Document tests that fail due to infrastructure for separate fix

### Implementation Summary

**Changes Made:**

1. **Added Mounted State Tracking** (line ~490)
   - Added `isMountedRef` using `useRef<boolean>(true)`
   - Added useEffect to set `isMountedRef.current = true` on mount and `false` on unmount

2. **Updated `checkAndShowAchievements` Function** (lines ~537-576)
   - Added mounted checks before and after async operations
   - Prevents state updates (`setEarnedAchievementIds`, `navigateTo`) on unmounted components
   - Handles Promise-based setTimeout cleanup through mounted guards

3. **Updated `handleCheckInSubmit` Timeout** (lines ~913-943)
   - Added mounted checks before async achievement check
   - Added mounted check after async operation completes
   - Added mounted check in catch block before navigation

4. **Updated `handleCardExerciseComplete` Timeout** (lines ~1317-1323)
   - Added mounted check before calling `checkAndShowAchievements`

5. **Updated `handleThemeCardClick` Timeout** (lines ~1386-1392)
   - Added mounted check before calling `checkAndShowAchievements`

**Files Modified:**
- `App.tsx`: Added mounted state tracking and guards to all timeout callbacks

**Linting Status:**
- ‚úÖ All linting checks passed (`npm run lint:all`)

**Remaining Manual Testing:**
- Test timeout cleanup on component unmount
- Verify no race conditions with multiple simultaneous timeouts

### QA Test Results

**Unit Tests:**
- ‚úÖ All 312 unit tests passed (1 skipped)
- ‚úÖ No regressions introduced by timeout cleanup changes

**E2E Tests:**
- ‚ö†Ô∏è 71 e2e tests failing with timeout/page closure errors
- Analysis: Failures appear to be pre-existing infrastructure issues, not related to timeout cleanup changes
- Error pattern: "Target page, context or browser has been closed" - suggests test environment/timeout issues
- All failures occur during test setup or button clicks, not during timeout execution
- Unit tests confirm timeout cleanup logic is working correctly

**Conclusion:**
The timeout cleanup implementation is correct and doesn't break existing functionality. E2e test failures appear to be pre-existing test infrastructure issues unrelated to the timeout cleanup changes.

---

## Previous Task (Completed)
**Task**: Global i18n migration for user-visible strings  
**Date Completed**: 2025-10-31  
**Status**: ‚úÖ **COMPLETED** (Archived)
**Archive**: `memory-bank/archive/archive-i18n-migration-user-point-manager.md`
**Reflection**: `memory-bank/reflection/reflection-i18n-migration-user-point-manager.md`

---

## üìã **Task History**

### Recent Completions
1. **Global i18n migration for user-visible strings** (2025-10-31) - Level 2
2. **User Points and Rewards System** (2025-01-13) - Level 3
3. **Telegram Direct-Link Full Screen & Back Button Fix** (2025-10-08) - Level 2
4. **PostHog Analytics Integration** (2025-09-30) - Level 2
5. **Theme Cards Logic Implementation** (2025-09-29) - Level 3
6. **Premium Theme Paywall Navigation** (2025-09-29) - Level 2
7. **Telegram User ID Display** (2025-09-29) - Level 2

---

*This file tracks the current active task. Previous tasks are archived in `memory-bank/archive/` and reflected in `memory-bank/reflection/`.*
