# Telegram Stars: Тестовые платежи

## ⚠️ Важно: Telegram Stars не поддерживает тестовый режим

В отличие от платежей за физические товары (через Stripe, Redsys и др.), **Telegram Stars не имеют тестового режима**. Все платежи Stars являются реальными и используют реальные средства пользователя.

### Разница между физическими и цифровыми товарами

**Физические товары:**
- Используют провайдеров платежей (Redsys, Stripe)
- Имеют тестовый режим через провайдера (Redsys Test, Stripe Test Mode)
- Используют обычные валюты (USD, EUR, RUB)
- Требуют адрес доставки

**Цифровые товары (Telegram Stars):**
- **НЕ используют провайдеров** (`provider_token: ""`)
- **НЕ имеют тестового режима** через провайдеров
- Используют только валюту XTR (Telegram Stars)
- Не требуют адреса доставки

**Важно:** Настройки Redsys Test/Live в @BotFather **не влияют** на Telegram Stars платежи. Для Stars не нужен провайдер платежей.

Подробнее: `docs/telegram-payments-providers-explanation.md`

## Что это означает

1. **Все платежи реальные** - пользователь тратит реальные Telegram Stars
2. **Нет тестовых карт** - нельзя использовать тестовые данные для Stars
3. **Нет "sandbox mode"** - все платежи проходят через реальную систему Telegram

## Как тестировать

### Автоматическое определение цены по боту

Система автоматически определяет цену на основе типа бота:

- **Тестовый бот** (из `TELEGRAM_TEST_BOT_IDS`): **1 Star** для всех планов
- **Продакшен бот**: Реальные цены (150, 1500, 2500 Stars)

**Никаких дополнительных настроек не требуется!** Просто используйте тестового бота для тестирования.

### Использование тестового бота (рекомендуется)

Используйте отдельного тестового бота (через `TELEGRAM_TEST_BOT_IDS`):

1. Создайте отдельного бота через @BotFather
2. Добавьте его `bot_id` в `TELEGRAM_TEST_BOT_IDS`
3. Используйте этот бот для тестирования
4. **Автоматически** цена будет **1 Star** для всех планов
5. Платежи будут помечены как `is_test_payment = true`
6. Эти платежи **не дадут премиум в продакшене**

### Тестирование с продакшен ботом

Если нужно протестировать с реальными ценами:

1. Используйте продакшен бота (не из `TELEGRAM_TEST_BOT_IDS`)
2. Цены будут реальными (150, 1500, 2500 Stars)
3. Платежи будут помечены как `is_test_payment = false`
4. Эти платежи **дадут премиум** (`users.has_premium = true`)

## Разница между тестовым и продакшен ботом

### Тестовый бот (`is_test_payment = true`):
- ✅ Платежи помечаются как тестовые в БД
- ✅ **Не дают премиум в продакшене** (`users.has_premium` не обновляется)
- ✅ Можно использовать для разработки и тестирования
- ⚠️ Платежи всё равно **реальные** (пользователь тратит реальные Stars)

### Продакшен бот (`is_test_payment = false`):
- ✅ Платежи дают премиум (`users.has_premium = true`)
- ✅ Используется для реальных пользователей
- ⚠️ Платежи **реальные**

## Рекомендации для тестирования

1. **Используйте тестового бота** - автоматически получите цену 1 Star для всех планов
2. **Проверяйте логи** - убедитесь, что `isTestPayment: true` и цена 1 Star
3. **Проверяйте БД** - тестовые платежи не должны обновлять `users.has_premium` в продакшене
4. **Используйте продакшен бота** только для финального тестирования с реальными ценами

## Как проверить, что используется тестовый бот

После создания инвойса проверьте логи Edge Function `create-premium-invoice`:

```
[create-premium-invoice] Invoice created: {
  telegramUserId: <id>,
  planType: "annually",
  botId: <bot_id>,
  isTestPayment: true,  // ← Должно быть true для тестового бота
  invoiceUrl: "..."
}
```

Если `isTestPayment: false`, но вы используете тестового бота, проверьте:
1. `bot_id` правильный
2. `TELEGRAM_TEST_BOT_IDS` настроен правильно
3. Бот действительно из списка тестовых

## Как это работает

Логика определения цены:

1. Система определяет `bot_id` из `initData` или токена
2. Проверяет, есть ли `bot_id` в `TELEGRAM_TEST_BOT_IDS`
3. Если да → цена **1 Star**, `is_test_payment = true`
4. Если нет → реальные цены, `is_test_payment = false`

**Всё автоматически!** Никаких дополнительных настроек не требуется.

## Итог

Telegram Stars не поддерживает тестовый режим. Для тестирования:

1. ✅ **Используйте тестового бота** (через `TELEGRAM_TEST_BOT_IDS`)
   - Автоматически цена будет **1 Star** для всех планов
   - Платежи помечаются как `is_test_payment = true`
   - Не дают премиум в продакшене

2. ✅ **Используйте продакшен бота** для финального тестирования
   - Реальные цены (150, 1500, 2500 Stars)
   - Платежи помечаются как `is_test_payment = false`
   - Дают премиум (`users.has_premium = true`)

3. ⚠️ **Помните:** Даже "тестовые" платежи реальные - пользователь тратит реальные Stars (просто цена 1 Star)
